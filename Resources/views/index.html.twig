{% extends 'base.html.twig' %}

{% block main %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Budget Plan-Actual Analysis</h3>
        </div>
        <div class="card-body">
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <label class="form-label" for="projectSelect">Проект</label>
                    <select id="projectSelect" class="form-select">
                        {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                        {% else %}
                            <option value="">Нет доступных проектов</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="projectStartDate">Дата начала проекта</label>
                    <input id="projectStartDate" type="date" class="form-control">
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="projectEndDate">Дата окончания проекта</label>
                    <input id="projectEndDate" type="date" class="form-control">
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="projectBudget">Бюджет проекта</label>
                    <input id="projectBudget" type="number" step="0.01" min="0" class="form-control" placeholder="Введите бюджет">
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered align-middle" id="budgetTable">
                    <thead id="budgetTableHead"></thead>
                    <tbody id="budgetTableBody"></tbody>
                    <tfoot>
                    <tr id="summaryRow">
                        <th colspan="2">Сумма (ставка × часы)</th>
                    </tr>
                    </tfoot>
                </table>
            </div>

            <div class="d-flex gap-2 mt-3">
                <button id="addRowButton" type="button" class="btn btn-outline-primary">+</button>
                <button id="buildChartButton" type="button" class="btn btn-primary">OK</button>
            </div>

            <div class="mt-4">
                <svg id="budgetChart" width="100%" height="320" viewBox="0 0 900 320" role="img" aria-label="График расходования бюджета"></svg>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        (function () {
            const placeholderEmployees = ['Иван Иванов', 'Мария Петрова', 'Степан Сидоров'];
            const state = {
                weeks: [],
                rowCount: 0,
            };

            const startInput = document.getElementById('projectStartDate');
            const endInput = document.getElementById('projectEndDate');
            const budgetInput = document.getElementById('projectBudget');
            const tableHead = document.getElementById('budgetTableHead');
            const tableBody = document.getElementById('budgetTableBody');
            const summaryRow = document.getElementById('summaryRow');
            const chartSvg = document.getElementById('budgetChart');

            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function getMonday(date) {
                const result = new Date(date);
                const day = result.getDay();
                const diff = day === 0 ? -6 : 1 - day;
                result.setDate(result.getDate() + diff);
                result.setHours(0, 0, 0, 0);
                return result;
            }

            function getSunday(date) {
                const monday = getMonday(date);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                sunday.setHours(23, 59, 59, 999);
                return sunday;
            }

            function getIsoWeek(date) {
                const target = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const dayNr = (target.getUTCDay() + 6) % 7;
                target.setUTCDate(target.getUTCDate() - dayNr + 3);
                const firstThursday = new Date(Date.UTC(target.getUTCFullYear(), 0, 4));
                const firstDayNr = (firstThursday.getUTCDay() + 6) % 7;
                firstThursday.setUTCDate(firstThursday.getUTCDate() - firstDayNr + 3);
                return 1 + Math.round((target - firstThursday) / 604800000);
            }

            function buildWeeks() {
                const startDate = new Date(startInput.value);
                const endDate = new Date(endInput.value);

                if (Number.isNaN(startDate.getTime()) || Number.isNaN(endDate.getTime()) || startDate > endDate) {
                    return [];
                }

                const periodStart = getMonday(startDate);
                periodStart.setDate(periodStart.getDate() - 7);

                const periodEnd = getSunday(endDate);
                periodEnd.setDate(periodEnd.getDate() + 14);

                const weeks = [];
                const cursor = new Date(periodStart);

                while (cursor <= periodEnd) {
                    const weekStart = new Date(cursor);
                    const weekEnd = new Date(cursor);
                    weekEnd.setDate(weekStart.getDate() + 6);

                    weeks.push({
                        start: weekStart,
                        end: weekEnd,
                        isoWeek: getIsoWeek(weekStart),
                        label: `W${getIsoWeek(weekStart)} (${formatDate(weekStart)} - ${formatDate(weekEnd)})`
                    });

                    cursor.setDate(cursor.getDate() + 7);
                }

                return weeks;
            }

            function createEmployeeOptions() {
                return placeholderEmployees
                    .map((employee) => `<option value="${employee}">${employee}</option>`)
                    .join('');
            }

            function createRow() {
                const tr = document.createElement('tr');
                tr.className = 'employee-row';
                tr.dataset.rowIndex = String(state.rowCount++);

                const employeeCell = document.createElement('td');
                employeeCell.innerHTML = `<select class="form-select">${createEmployeeOptions()}</select>`;

                const rateCell = document.createElement('td');
                rateCell.innerHTML = '<input type="number" min="0" step="0.01" class="form-control rate-input" value="0">';

                tr.appendChild(employeeCell);
                tr.appendChild(rateCell);

                for (let weekIndex = 0; weekIndex < state.weeks.length; weekIndex++) {
                    const hourCell = document.createElement('td');
                    hourCell.innerHTML = `<input type="number" min="0" step="0.1" class="form-control hour-input" data-week-index="${weekIndex}" value="0">`;
                    tr.appendChild(hourCell);
                }

                tableBody.appendChild(tr);
            }

            function renderTableStructure() {
                state.weeks = buildWeeks();

                tableHead.innerHTML = '';
                summaryRow.querySelectorAll('td').forEach((cell) => cell.remove());

                const headRow = document.createElement('tr');
                headRow.innerHTML = '<th>ФИО сотрудника</th><th>Часовая ставка</th>';

                state.weeks.forEach((week) => {
                    const th = document.createElement('th');
                    th.textContent = week.label;
                    headRow.appendChild(th);

                    const summaryCell = document.createElement('td');
                    summaryCell.className = 'summary-cell';
                    summaryCell.dataset.weekIndex = String(summaryRow.querySelectorAll('td').length);
                    summaryCell.textContent = '0';
                    summaryRow.appendChild(summaryCell);
                });

                tableHead.appendChild(headRow);

                const existingRowsData = Array.from(tableBody.querySelectorAll('tr')).map((row) => {
                    const employee = row.querySelector('select')?.value || placeholderEmployees[0];
                    const rate = row.querySelector('.rate-input')?.value || '0';
                    const hours = Array.from(row.querySelectorAll('.hour-input')).map((input) => input.value);
                    return {employee, rate, hours};
                });

                tableBody.innerHTML = '';
                state.rowCount = 0;

                if (existingRowsData.length === 0) {
                    for (let i = 0; i < 3; i++) {
                        createRow();
                    }
                } else {
                    existingRowsData.forEach((rowData) => {
                        createRow();
                        const row = tableBody.lastElementChild;
                        row.querySelector('select').value = rowData.employee;
                        row.querySelector('.rate-input').value = rowData.rate;
                        row.querySelectorAll('.hour-input').forEach((input, index) => {
                            input.value = rowData.hours[index] || '0';
                        });
                    });
                }

                calculateSummary();
            }

            function calculateSummary() {
                const totals = new Array(state.weeks.length).fill(0);
                const rows = tableBody.querySelectorAll('tr');

                rows.forEach((row) => {
                    const rate = parseFloat(row.querySelector('.rate-input')?.value || '0') || 0;
                    row.querySelectorAll('.hour-input').forEach((input, weekIndex) => {
                        const hours = parseFloat(input.value || '0') || 0;
                        totals[weekIndex] += rate * hours;
                    });
                });

                const summaryCells = summaryRow.querySelectorAll('.summary-cell');
                summaryCells.forEach((cell, index) => {
                    cell.textContent = totals[index].toFixed(2);
                });

                return totals;
            }

            function renderChart() {
                const budget = parseFloat(budgetInput.value || '0') || 0;
                const totals = calculateSummary();
                const values = [];

                if (state.weeks.length === 0) {
                    chartSvg.innerHTML = '<text x="20" y="40">Выберите корректный период дат.</text>';
                    return;
                }

                for (let i = 0; i < state.weeks.length; i++) {
                    if (i === 0) {
                        values.push(budget);
                    } else {
                        values.push(values[i - 1] - totals[i - 1]);
                    }
                }

                const padding = {left: 60, right: 20, top: 20, bottom: 50};
                const width = 900;
                const height = 320;
                const innerWidth = width - padding.left - padding.right;
                const innerHeight = height - padding.top - padding.bottom;
                const minValue = Math.min(...values, 0);
                const maxValue = Math.max(...values, budget, 1);
                const range = maxValue - minValue || 1;

                const points = values.map((value, index) => {
                    const x = padding.left + (index * innerWidth) / Math.max(values.length - 1, 1);
                    const y = padding.top + ((maxValue - value) / range) * innerHeight;
                    return {x, y, value};
                });

                chartSvg.setAttribute('viewBox', `0 0 ${width} ${height}`);
                chartSvg.innerHTML = `
                    <line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}" stroke="#333" />
                    <line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}" stroke="#333" />
                    <polyline fill="none" stroke="#206bc4" stroke-width="2" points="${points.map((point) => `${point.x},${point.y}`).join(' ')}" />
                    ${points.map((point) => `<circle cx="${point.x}" cy="${point.y}" r="3" fill="#206bc4" />`).join('')}
                    ${points.map((point, index) => `<text x="${point.x}" y="${height - padding.bottom + 20}" text-anchor="middle" font-size="11">${state.weeks[index].isoWeek}</text>`).join('')}
                    ${points.map((point) => `<text x="${point.x}" y="${point.y - 8}" text-anchor="middle" font-size="10">${point.value.toFixed(0)}</text>`).join('')}
                    <text x="${width / 2}" y="${height - 10}" text-anchor="middle" font-size="12">Номер недели</text>
                    <text x="18" y="${height / 2}" text-anchor="middle" font-size="12" transform="rotate(-90 18 ${height / 2})">Остаток бюджета</text>
                `;
            }

            function initializeDates() {
                const today = new Date();
                const inFourMonths = new Date(today);
                inFourMonths.setMonth(inFourMonths.getMonth() + 4);

                startInput.value = formatDate(today);
                endInput.value = formatDate(inFourMonths);
            }

            document.getElementById('addRowButton').addEventListener('click', function () {
                createRow();
                calculateSummary();
            });

            document.getElementById('buildChartButton').addEventListener('click', function () {
                renderChart();
            });

            tableBody.addEventListener('input', function (event) {
                if (event.target.classList.contains('hour-input') || event.target.classList.contains('rate-input')) {
                    calculateSummary();
                }
            });

            startInput.addEventListener('change', renderTableStructure);
            endInput.addEventListener('change', renderTableStructure);

            initializeDates();
            renderTableStructure();
            renderChart();
        })();
    </script>
{% endblock %}
