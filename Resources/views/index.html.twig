{% extends 'base.html.twig' %}

{% block main %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Budget Plan-Actual Analysis</h3>
        </div>
        <div class="card-body">
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <label class="form-label" for="projectSelect">Проект</label>
                    <select id="projectSelect" class="form-select">
                        {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                        {% else %}
                            <option value="">Нет доступных проектов</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Дата начала проекта</label>
                    <div id="projectStartDateLabel" class="form-control-plaintext border rounded px-2 py-2 bg-light">—</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Дата окончания проекта</label>
                    <div id="projectEndDateLabel" class="form-control-plaintext border rounded px-2 py-2 bg-light">—</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Бюджет проекта</label>
                    <div id="projectBudgetLabel" class="form-control-plaintext border rounded px-2 py-2 bg-light">0</div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered align-middle" id="budgetTable">
                    <thead id="budgetTableHead"></thead>
                    <tbody id="budgetTableBody"></tbody>
                    <tfoot>
                    <tr id="summaryRow">
                        <th colspan="2">Сумма (ставка × часы)</th>
                    </tr>
                    </tfoot>
                </table>
            </div>

            <div class="d-flex gap-2 mt-3">
                <button id="addRowButton" type="button" class="btn btn-outline-primary">+</button>
                <button id="buildChartButton" type="button" class="btn btn-primary">OK</button>
            </div>

            <div class="mt-4">
                <svg id="budgetChart" width="100%" height="320" viewBox="0 0 900 320" role="img" aria-label="График расходования бюджета"></svg>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        (function () {
            const projects = {{ project_data|json_encode|raw }};
            const employees = {{ employees|json_encode|raw }};
            const employeeMap = new Map(employees.map((employee) => [String(employee.id), employee]));
            const state = {
                weeks: [],
                rowCount: 0,
                activeProject: null,
                activeBudget: 0,
            };

            const projectSelect = document.getElementById('projectSelect');
            const projectStartDateLabel = document.getElementById('projectStartDateLabel');
            const projectEndDateLabel = document.getElementById('projectEndDateLabel');
            const projectBudgetLabel = document.getElementById('projectBudgetLabel');
            const tableHead = document.getElementById('budgetTableHead');
            const tableBody = document.getElementById('budgetTableBody');
            const summaryRow = document.getElementById('summaryRow');
            const chartSvg = document.getElementById('budgetChart');

            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function getMonday(date) {
                const result = new Date(date);
                const day = result.getDay();
                const diff = day === 0 ? -6 : 1 - day;
                result.setDate(result.getDate() + diff);
                result.setHours(0, 0, 0, 0);
                return result;
            }

            function getSunday(date) {
                const monday = getMonday(date);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                sunday.setHours(23, 59, 59, 999);
                return sunday;
            }

            function getIsoWeek(date) {
                const target = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const dayNr = (target.getUTCDay() + 6) % 7;
                target.setUTCDate(target.getUTCDate() - dayNr + 3);
                const firstThursday = new Date(Date.UTC(target.getUTCFullYear(), 0, 4));
                const firstDayNr = (firstThursday.getUTCDay() + 6) % 7;
                firstThursday.setUTCDate(firstThursday.getUTCDate() - firstDayNr + 3);
                return 1 + Math.round((target - firstThursday) / 604800000);
            }

            function getWeekLabel(weekStart) {
                const week = getIsoWeek(weekStart);
                const yearShort = String(weekStart.getFullYear()).slice(-2);
                return `W${week}-${yearShort}`;
            }

            function buildWeeks() {
                if (!state.activeProject || !state.activeProject.start || !state.activeProject.end) {
                    return [];
                }

                const startDate = new Date(state.activeProject.start);
                const endDate = new Date(state.activeProject.end);

                if (Number.isNaN(startDate.getTime()) || Number.isNaN(endDate.getTime()) || startDate > endDate) {
                    return [];
                }

                const periodStart = getMonday(startDate);
                periodStart.setDate(periodStart.getDate() - 7);

                const periodEnd = getSunday(endDate);
                periodEnd.setDate(periodEnd.getDate() + 14);

                const weeks = [];
                const cursor = new Date(periodStart);

                while (cursor <= periodEnd) {
                    const weekStart = new Date(cursor);
                    weeks.push({
                        start: weekStart,
                        isoWeek: getIsoWeek(weekStart),
                        label: getWeekLabel(weekStart),
                    });
                    cursor.setDate(cursor.getDate() + 7);
                }

                return weeks;
            }

            function createEmployeeOptions() {
                if (employees.length === 0) {
                    return '<option value="">Нет сотрудников</option>';
                }

                return employees
                    .map((employee) => `<option value="${employee.id}">${employee.name}</option>`)
                    .join('');
            }

            function updateRowRate(row) {
                const select = row.querySelector('.employee-select');
                const rateLabel = row.querySelector('.rate-label');
                const employee = employeeMap.get(String(select.value));
                const rate = employee ? Number(employee.hourlyRate || 0) : 0;
                rateLabel.textContent = rate.toFixed(2);
                row.dataset.rate = String(rate);
            }

            function createRow(initialEmployeeId = null, hourValues = []) {
                const tr = document.createElement('tr');
                tr.className = 'employee-row';
                tr.dataset.rowIndex = String(state.rowCount++);
                tr.dataset.rate = '0';

                const employeeCell = document.createElement('td');
                employeeCell.innerHTML = `<select class="form-select employee-select">${createEmployeeOptions()}</select>`;

                const rateCell = document.createElement('td');
                rateCell.innerHTML = '<span class="rate-label">0.00</span>';

                tr.appendChild(employeeCell);
                tr.appendChild(rateCell);

                for (let weekIndex = 0; weekIndex < state.weeks.length; weekIndex++) {
                    const hourCell = document.createElement('td');
                    const value = hourValues[weekIndex] ?? '0';
                    hourCell.innerHTML = `<input type="number" min="0" step="0.1" class="form-control hour-input" data-week-index="${weekIndex}" value="${value}">`;
                    tr.appendChild(hourCell);
                }

                tableBody.appendChild(tr);

                const select = tr.querySelector('.employee-select');
                if (initialEmployeeId !== null) {
                    select.value = String(initialEmployeeId);
                }
                if (!select.value && employees.length > 0) {
                    select.value = String(employees[0].id);
                }

                updateRowRate(tr);
            }

            function renderTableStructure() {
                state.weeks = buildWeeks();

                tableHead.innerHTML = '';
                summaryRow.querySelectorAll('td').forEach((cell) => cell.remove());

                const headRow = document.createElement('tr');
                headRow.innerHTML = '<th>ФИО сотрудника</th><th>Часовая ставка</th>';

                state.weeks.forEach((week) => {
                    const th = document.createElement('th');
                    th.textContent = week.label;
                    headRow.appendChild(th);

                    const summaryCell = document.createElement('td');
                    summaryCell.className = 'summary-cell';
                    summaryCell.textContent = '0.00';
                    summaryRow.appendChild(summaryCell);
                });

                tableHead.appendChild(headRow);

                const existingRowsData = Array.from(tableBody.querySelectorAll('tr')).map((row) => ({
                    employeeId: row.querySelector('.employee-select')?.value ?? null,
                    hours: Array.from(row.querySelectorAll('.hour-input')).map((input) => input.value),
                }));

                tableBody.innerHTML = '';
                state.rowCount = 0;

                if (existingRowsData.length === 0) {
                    for (let i = 0; i < 3; i++) {
                        const fallback = employees[i] ? employees[i].id : null;
                        createRow(fallback);
                    }
                } else {
                    existingRowsData.forEach((rowData) => {
                        createRow(rowData.employeeId, rowData.hours);
                    });
                }

                calculateSummary();
            }

            function calculateSummary() {
                const totals = new Array(state.weeks.length).fill(0);

                tableBody.querySelectorAll('tr').forEach((row) => {
                    const rate = parseFloat(row.dataset.rate || '0') || 0;
                    row.querySelectorAll('.hour-input').forEach((input, weekIndex) => {
                        const hours = parseFloat(input.value || '0') || 0;
                        totals[weekIndex] += rate * hours;
                    });
                });

                summaryRow.querySelectorAll('.summary-cell').forEach((cell, index) => {
                    cell.textContent = totals[index].toFixed(2);
                });

                return totals;
            }

            function renderChart() {
                const budget = state.activeBudget || 0;
                const totals = calculateSummary();
                const values = [];

                if (state.weeks.length === 0) {
                    chartSvg.innerHTML = '<text x="20" y="40">У выбранного проекта нет корректных дат.</text>';
                    return;
                }

                for (let i = 0; i < state.weeks.length; i++) {
                    values.push(i === 0 ? budget : values[i - 1] - totals[i - 1]);
                }

                const padding = {left: 60, right: 20, top: 20, bottom: 50};
                const width = 900;
                const height = 320;
                const innerWidth = width - padding.left - padding.right;
                const innerHeight = height - padding.top - padding.bottom;
                const minValue = Math.min(...values, 0);
                const maxValue = Math.max(...values, budget, 1);
                const range = maxValue - minValue || 1;

                const points = values.map((value, index) => {
                    const x = padding.left + (index * innerWidth) / Math.max(values.length - 1, 1);
                    const y = padding.top + ((maxValue - value) / range) * innerHeight;
                    return {x, y, value};
                });

                chartSvg.setAttribute('viewBox', `0 0 ${width} ${height}`);
                chartSvg.innerHTML = `
                    <line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}" stroke="#333" />
                    <line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}" stroke="#333" />
                    <polyline fill="none" stroke="#206bc4" stroke-width="2" points="${points.map((point) => `${point.x},${point.y}`).join(' ')}" />
                    ${points.map((point) => `<circle cx="${point.x}" cy="${point.y}" r="3" fill="#206bc4" />`).join('')}
                    ${points.map((point, index) => `<text x="${point.x}" y="${height - padding.bottom + 20}" text-anchor="middle" font-size="11">${state.weeks[index].label}</text>`).join('')}
                    ${points.map((point) => `<text x="${point.x}" y="${point.y - 8}" text-anchor="middle" font-size="10">${point.value.toFixed(0)}</text>`).join('')}
                    <text x="${width / 2}" y="${height - 10}" text-anchor="middle" font-size="12">Неделя</text>
                    <text x="18" y="${height / 2}" text-anchor="middle" font-size="12" transform="rotate(-90 18 ${height / 2})">Остаток бюджета</text>
                `;
            }

            function applyProject(projectId) {
                state.activeProject = projects.find((project) => String(project.id) === String(projectId)) || null;
                const start = state.activeProject?.start ?? '—';
                const end = state.activeProject?.end ?? '—';
                const budget = Number(state.activeProject?.budget ?? 0);
                state.activeBudget = budget;

                projectStartDateLabel.textContent = start;
                projectEndDateLabel.textContent = end;
                projectBudgetLabel.textContent = budget.toFixed(2);

                renderTableStructure();
                renderChart();
            }

            document.getElementById('addRowButton').addEventListener('click', function () {
                createRow();
                calculateSummary();
            });

            document.getElementById('buildChartButton').addEventListener('click', function () {
                renderChart();
            });

            projectSelect.addEventListener('change', function () {
                applyProject(this.value);
            });

            tableBody.addEventListener('change', function (event) {
                if (event.target.classList.contains('employee-select')) {
                    updateRowRate(event.target.closest('tr'));
                    calculateSummary();
                }
            });

            tableBody.addEventListener('input', function (event) {
                if (event.target.classList.contains('hour-input')) {
                    calculateSummary();
                }
            });

            if (projectSelect.value) {
                applyProject(projectSelect.value);
            } else if (projects.length > 0) {
                projectSelect.value = String(projects[0].id);
                applyProject(projectSelect.value);
            } else {
                renderTableStructure();
                renderChart();
            }
        })();
    </script>
{% endblock %}
